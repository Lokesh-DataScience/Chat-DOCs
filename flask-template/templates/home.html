{% extends 'base.html' %}

{% block content %}
<div class="chat-container">

    <!-- Chat Box -->
    <div id="chat-box" class="chat-box"></div>

    <!-- Chat Input -->
    <form id="chat-form" action="/api/ask" method="POST" class="chat-form">
        <div class="input-group">
            <input type="text" id="question" name="question" placeholder="Type a message..." required>
            <button type="submit" title="Send">
                <i class="fas fa-paper-plane"></i> Send
            </button>
        </div>
    </form>

    <p id="chat-status" class="status-message"></p>

    <!-- Document Upload -->
    <div class="upload-container">
        <h2>Upload Documents</h2>
        
        <form id="process-form" action="/api/process-docs" method="POST" enctype="multipart/form-data">
            <label for="documents" class="upload-label">Select Documents (PDF, DOCX, TXT):</label>
            <input type="file" id="documents" name="documents" multiple required>
            <button type="submit" id="process-btn" class="upload-btn">Process Documents</button>
        </form>

        <!-- Display uploaded files -->
        <div class="uploaded-files">
            <h3>Uploaded Files:</h3>
            <ul>
                {% if uploaded_files %}
                    {% for file in uploaded_files %}
                        <li>{{ file }}</li>
                    {% endfor %}
                {% else %}
                    <li>No files uploaded yet.</li>
                {% endif %}
            </ul>
        </div>

        <p id="process-status" class="status-message"></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const BASE_URL = window.location.origin;  // Use this globally for all requests

    // ✅ Helper function for API calls
    async function apiRequest(url, method = 'GET', body = null, isFormData = false) {
        try {
            const options = {
                method: method,
                body: body
            };
    
            // Don't include headers for FormData
            if (!isFormData) {
                options.headers = { 'Content-Type': 'application/json' };
            }
    
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
    
            return await response.json();
        } catch (error) {
            console.error('API Request Error:', error);
            return null;
        }
    }
    
    document.getElementById('process-form').addEventListener('submit', async (event) => {  // Use "click" event
        event.preventDefault();
        event.stopPropagation();
        const form = document.getElementById('process-form');
        const formData = new FormData(form);

        try {
            const response = await fetch(`/api/process-docs`, {
                method: 'POST',
                body: formData
            });
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const result = await response.json();

            document.getElementById('process-status').textContent = result.message || 'Document processing complete!';
        } catch (error) {
            console.error('Failed:', error);
            document.getElementById('process-status').textContent = 'Document processing failed!';
        }
    });
    
    // ✅ Handle chat submission
    document.getElementById('chat-form').addEventListener('submit', async (event) => {
        event.preventDefault();
    
        const inputField = document.getElementById('question');
        const question = inputField.value;
        if (!question) return;
    
        const requestBody = JSON.stringify({ question: question });
    
        try {
            const response = await apiRequest(`${BASE_URL}/api/ask`, 'POST', requestBody);
    
            if (response) {
                const chatBox = document.getElementById('chat-box');
    
                // ✅ Display User Message
                appendMessage('user', question);
    
                // ✅ Display Bot Response
                appendMessage('bot', response.response);
    
                // ✅ Scroll to latest message
                chatBox.scrollTop = chatBox.scrollHeight;
    
                inputField.value = "";
            }
        } catch (error) {
            console.error('Failed:', error);
        }
    });
    
    // ✅ Function to append messages with timestamps
    function appendMessage(sender, message) {
        const chatBox = document.getElementById('chat-box');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
    
        // Add timestamp
        const timestamp = new Date().toLocaleTimeString();
        messageDiv.innerHTML = `
            <p>${message}</p>
            <span class="timestamp">${timestamp}</span>
        `;
    
        chatBox.appendChild(messageDiv);
    }
    
</script>
{% endblock %}
